<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>D'NestGlobal App</title>

  <!-- Critical PWA Meta Tags -->
  <meta name="theme-color" content="#000000">
  <meta name="description" content="D'NestGlobal Progressive Web Application">
  <meta name="application-name" content="D'NestGlobal">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="D'NestGlobal">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Icons with absolute paths -->
  <link rel="icon" type="image/png" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" href="/favicon-32x32.png">
  <link rel="manifest" href="https://dnestcandy-droid.github.io/pwa-test/manifest.json" crossorigin="use-credentials">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .app-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .feature-list {
      margin: 20px 0;
    }

    .feature-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    /* Install Section */
    .install-section {
      background: #e8f5e8;
      border: 2px solid #00c853;
      border-radius: 15px;
      padding: 20px;
      margin: 25px 0;
      text-align: center;
    }

    .install-btn {
      background: linear-gradient(135deg, #00c853, #64dd17);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      box-shadow: 0 4px 15px rgba(0,200,83,0.3);
      transition: all 0.3s ease;
    }

    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,200,83,0.4);
    }

    .install-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Platform Instructions */
    .instructions {
      background: #e3f2fd;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }

    .instructions.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .instructions h3 {
      color: #1976d2;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .instructions ol {
      margin: 15px 0;
      padding-left: 20px;
    }

    .instructions li {
      margin: 12px 0;
      line-height: 1.5;
    }

    /* Status Panel */
    .status-panel {
      background: #2c3e50;
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .status-good { background: #00c853; animation: pulse 2s infinite; }
    .status-warning { background: #ff9800; }
    .status-bad { background: #f44336; }

    /* Debug Info */
    .debug-info {
      background: #1a1a1a;
      color: #00ff00;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .app-container {
        padding: 20px;
        border-radius: 15px;
      }
      
      .install-btn {
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>üöÄ D'NestGlobal</h1>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">Progressive Web App</p>

    <div class="feature-list">
      <div class="feature-item">
        <span style="margin-right: 10px;">üì±</span>
        <span>Install on your home screen</span>
      </div>
      <div class="feature-item">
        <span style="margin-right: 10px;">‚ö°</span>
        <span>Fast loading & offline support</span>
      </div>
      <div class="feature-item">
        <span style="margin-right: 10px;">üîî</span>
        <span>Push notifications</span>
      </div>
    </div>

    <!-- Install Section -->
    <div class="install-section">
      <h3>üì≤ Install Our App</h3>
      <p>Get the full mobile experience with home screen access</p>
      
      <button class="install-btn" id="androidInstall" disabled>
        <span id="androidText">Install for Android</span>
        <span id="androidLoader" style="display:none;">üîÑ Checking...</span>
      </button>
      
      <button class="install-btn" id="iosInstall">
        üì± Install for iPhone
      </button>
    </div>

    <!-- Android Instructions -->
    <div class="instructions" id="androidInstructions">
      <h3>ü§ñ Android Installation</h3>
      <p>Follow these steps to install:</p>
      <ol>
        <li>Wait for the "Add to Home Screen" prompt</li>
        <li>Or tap the 3-dot menu ‚Üí "Install app"</li>
        <li>Or tap "Add to Home Screen" in the browser menu</li>
      </ol>
      <p><em>The app will appear on your home screen!</em></p>
    </div>

    <!-- iOS Instructions -->
    <div class="instructions" id="iosInstructions">
      <h3>üçé iPhone Installation</h3>
      <p>Follow these steps:</p>
      <ol>
        <li>Tap the <strong>Share button</strong> <span style="font-size:18px">‚éã</span> at the bottom</li>
        <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
        <li>Tap <strong>"Add"</strong> in the top right corner</li>
      </ol>
      <p><em>The app will now appear on your home screen!</em></p>
    </div>

    <!-- Status Panel -->
    <div class="status-panel">
      <h3 style="color: white; margin-bottom: 15px;">üîç Installation Status</h3>
      <div id="statusItems">
        <div class="status-item">
          <span>PWA Detect</span>
          <div>
            <span class="status-indicator status-bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>Service Worker</span>
          <div>
            <span class="status-indicator status-bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>Manifest</span>
          <div>
            <span class="status-indicator status-bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>HTTPS</span>
          <div>
            <span class="status-indicator status-bad"></span>
            <span>Checking...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Console -->
    <div class="debug-info">
      <strong>Console Output:</strong>
      <div id="debugConsole">Initializing D'NestGlobal PWA...</div>
    </div>
  </div>

<script>
class PWAInstaller {
  constructor() {
    this.deferredPrompt = null;
    this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    this.isAndroid = /Android/.test(navigator.userAgent);
    this.isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone;
    
    this.elements = {
      androidInstall: document.getElementById('androidInstall'),
      iosInstall: document.getElementById('iosInstall'),
      androidInstructions: document.getElementById('androidInstructions'),
      iosInstructions: document.getElementById('iosInstructions'),
      statusItems: document.getElementById('statusItems'),
      debugConsole: document.getElementById('debugConsole')
    };

    this.init();
  }

  log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
    const messageHTML = `<div>${icons[type]} [${timestamp}] ${message}</div>`;
    
    console.log(`PWA: ${message}`);
    if (this.elements.debugConsole) {
      this.elements.debugConsole.innerHTML += messageHTML;
      this.elements.debugConsole.scrollTop = this.elements.debugConsole.scrollHeight;
    }
  }

  updateStatus(item, status, message) {
    const statusMap = {
      good: { class: 'status-good', text: '‚úì' },
      warning: { class: 'status-warning', text: '‚ö†' },
      bad: { class: 'status-bad', text: '‚úó' }
    };

    const statusElement = this.elements.statusItems.children[item];
    if (statusElement) {
      const indicator = statusElement.querySelector('.status-indicator');
      const text = statusElement.querySelector('.status-item div span:last-child');
      
      if (indicator) {
        indicator.className = `status-indicator ${statusMap[status].class}`;
      }
      if (text) {
        text.textContent = message;
      }
    }
  }

  async checkRequirements() {
    this.log('Checking PWA requirements...');
    
    // Check HTTPS/Localhost
    const isSecure = location.protocol === 'https:' || 
                    location.hostname === 'localhost' || 
                    location.hostname === '127.0.0.1';
    this.updateStatus(3, isSecure ? 'good' : 'warning', 
      isSecure ? 'Secure Connection' : 'Not HTTPS (may not install)');

    // Check Manifest
    const hasManifest = document.querySelector('link[rel="manifest"]') !== null;
    this.updateStatus(2, hasManifest ? 'good' : 'bad', 
      hasManifest ? 'Manifest Found' : 'No Manifest');

    // Check Service Worker
    const hasSW = 'serviceWorker' in navigator;
    this.updateStatus(1, hasSW ? 'good' : 'bad', 
      hasSW ? 'Supported' : 'Not Supported');

    return { isSecure, hasManifest, hasSW };
  }

  async registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
      this.log('Service Worker not supported', 'error');
      return false;
    }

    try {
      // Use absolute path for service worker
      const registration = await navigator.serviceWorker.register('/service-worker.js', {
        scope: '/',
        updateViaCache: 'none'
      });

      this.log('Service Worker registered successfully', 'success');
      
      // Wait for service worker to be ready
      if (registration.installing) {
        await new Promise(resolve => {
          registration.installing.addEventListener('statechange', (e) => {
            if (e.target.state === 'activated') {
              resolve();
            }
          });
        });
      }

      return true;
    } catch (error) {
      this.log(`Service Worker failed: ${error.message}`, 'error');
      return false;
    }
  }

  setupEventListeners() {
    // Android/Chrome beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      this.log('üéØ PWA installation available!', 'success');
      e.preventDefault();
      this.deferredPrompt = e;
      
      // Enable Android install button
      if (this.elements.androidInstall) {
        this.elements.androidInstall.disabled = false;
        this.elements.androidInstall.querySelector('#androidText').textContent = 'üì≤ Install Now';
      }
      
      // Show Android instructions
      if (this.elements.androidInstructions) {
        this.elements.androidInstructions.classList.add('active');
      }

      this.updateStatus(0, 'good', 'Ready to Install!');
    });

    // Android install button
    if (this.elements.androidInstall) {
      this.elements.androidInstall.addEventListener('click', () => this.installPWA());
    }

    // iOS install button
    if (this.elements.iosInstall) {
      this.elements.iosInstall.addEventListener('click', () => this.showIOSInstructions());
    }

    // Track successful installation
    window.addEventListener('appinstalled', () => {
      this.log('üéâ PWA successfully installed!', 'success');
      this.deferredPrompt = null;
      this.updateStatus(0, 'good', 'Installed! üéâ');
    });
  }

  async installPWA() {
    if (this.deferredPrompt) {
      this.log('Starting PWA installation...');
      this.deferredPrompt.prompt();
      
      const choiceResult = await this.deferredPrompt.userChoice;
      this.log(`User choice: ${choiceResult.outcome}`, 'success');
      
      this.deferredPrompt = null;
    } else {
      this.log('Installation not available yet', 'warning');
      alert('Installation will be available soon. Please ensure:\n1. You are using Chrome/Edge on Android\n2. You have visited this site before\n3. You are not in incognito mode');
    }
  }

  showIOSInstructions() {
    if (this.elements.iosInstructions) {
      this.elements.iosInstructions.classList.add('active');
      this.log('Showing iOS installation instructions', 'info');
    }
  }

  async init() {
    this.log('Initializing D\'NestGlobal PWA...');
    
    // Update platform info
    this.log(`Platform: ${this.isIOS ? 'iOS' : this.isAndroid ? 'Android' : 'Other'}`);
    this.log(`Standalone: ${this.isStandalone ? 'Yes' : 'No'}`);
    this.log(`User Agent: ${navigator.userAgent}`);

    // Check requirements
    const requirements = await this.checkRequirements();
    
    // Register service worker
    if (requirements.hasSW) {
      await this.registerServiceWorker();
    }

    // Setup event listeners
    this.setupEventListeners();

    // Show iOS instructions by default on iOS
    if (this.isIOS && !this.isStandalone) {
      this.showIOSInstructions();
    }

    // Final status
    if (this.isStandalone) {
      this.updateStatus(0, 'good', 'Running as Installed App!');
      this.log('App is running in standalone mode', 'success');
    }

    this.log('PWA initialization complete');
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  window.pwaInstaller = new PWAInstaller();
});

window.matchMedia('(display-mode: standalone)').addEventListener('change', (evt) => {
  const mode = evt.matches ? 'standalone' : 'browser';
  console.log(`Display mode changed to: ${mode}`);
});

</script>

</body>
</html>
