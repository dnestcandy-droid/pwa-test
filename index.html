<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D'NestGlobal App</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#000000">
  <meta name="description" content="D'NestGlobal Progressive Web Application">
  <meta name="application-name" content="D'NestGlobal">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="D'NestGlobal">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Icons -->
  <link rel="icon" type="image/png" href="favicon-32x32.png">
  <link rel="apple-touch-icon" href="favicon-32x32.png">
  <link rel="manifest" href="manifest.json">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .feature {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .install-section {
      background: #e8f5e8;
      border: 2px solid #00c853;
      border-radius: 15px;
      padding: 25px;
      margin: 25px 0;
    }

    .install-btn {
      background: linear-gradient(135deg, #00c853, #64dd17);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      width: 200px;
    }

    .install-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .instructions {
      background: #e3f2fd;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
      display: none;
    }

    .instructions.active {
      display: block;
    }

    .status-panel {
      background: #2c3e50;
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .good { background: #00c853; }
    .warning { background: #ff9800; }
    .bad { background: #f44336; }

    .debug {
      background: #1a1a1a;
      color: #00ff00;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      text-align: left;
    }

    .manual-install {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ D'NestGlobal</h1>
    <p class="subtitle">Progressive Web App</p>

    <div class="feature">
      <span>üì± Install on home screen</span>
    </div>
    <div class="feature">
      <span>‚ö° Fast loading & offline support</span>
    </div>
    <div class="feature">
      <span>üîî Push notifications</span>
    </div>

    <div class="install-section">
      <h3>üì≤ Install Our App</h3>
      <p>Get the full mobile experience</p>
      
      <div>
        <button class="install-btn" id="installBtn" disabled>
          Install App
        </button>
      </div>
    </div>

    <div class="manual-install">
      <h3>üîß Manual Installation</h3>
      <p><strong>Android:</strong> Chrome menu ‚Üí "Add to Home screen"</p>
      <p><strong>iPhone:</strong> Share button ‚Üí "Add to Home Screen"</p>
    </div>

    <div class="instructions" id="androidInstructions">
      <h3>ü§ñ Android Installation</h3>
      <ol>
        <li>Tap Chrome menu (3 dots) in top right</li>
        <li>Select "Add to Home screen"</li>
        <li>Confirm installation</li>
      </ol>
    </div>

    <div class="instructions" id="iosInstructions">
      <h3>üçé iPhone Installation</h3>
      <ol>
        <li>Tap Share button <span style="font-size:18px">‚éã</span> at bottom</li>
        <li>Scroll down and select "Add to Home Screen"</li>
        <li>Tap "Add" in top right corner</li>
      </ol>
    </div>

    <div class="status-panel">
      <h3 style="color: white; text-align: center;">üîç PWA Status</h3>
      <div id="statusItems">
        <div class="status-item">
          <span>Service Worker</span>
          <div>
            <span class="status-indicator bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>Web App Manifest</span>
          <div>
            <span class="status-indicator bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>Installable</span>
          <div>
            <span class="status-indicator bad"></span>
            <span>Checking...</span>
          </div>
        </div>
        <div class="status-item">
          <span>Standalone Mode</span>
          <div>
            <span class="status-indicator bad"></span>
            <span id="standaloneStatus">Checking...</span>
          </div>
        </div>
      </div>
    </div>

    <div class="debug">
      <strong>Debug Console:</strong>
      <div id="debugConsole">Initializing PWA...</div>
    </div>
  </div>

<script>
// PWA Manager for GitHub Pages
class PWAManager {
  constructor() {
    this.deferredPrompt = null;
    this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    this.isAndroid = /Android/.test(navigator.userAgent);
    this.isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    this.isGitHubPages = window.location.hostname.includes('github.io');
    
    this.elements = {
      installBtn: document.getElementById('installBtn'),
      androidInstructions: document.getElementById('androidInstructions'),
      iosInstructions: document.getElementById('iosInstructions'),
      statusItems: document.getElementById('statusItems'),
      debugConsole: document.getElementById('debugConsole'),
      standaloneStatus: document.getElementById('standaloneStatus')
    };

    this.init();
  }

  log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const icons = { 
      info: '‚ÑπÔ∏è', 
      success: '‚úÖ', 
      error: '‚ùå', 
      warning: '‚ö†Ô∏è',
      rocket: 'üöÄ',
      mobile: 'üì±'
    };
    
    const messageHTML = `<div>${icons[type] || 'üìù'} [${timestamp}] ${message}</div>`;
    
    console.log(`PWA: ${message}`);
    if (this.elements.debugConsole) {
      this.elements.debugConsole.innerHTML += messageHTML;
      this.elements.debugConsole.scrollTop = this.elements.debugConsole.scrollHeight;
    }
  }

  updateStatus(index, status, message) {
    if (this.elements.statusItems && this.elements.statusItems.children[index]) {
      const statusElement = this.elements.statusItems.children[index];
      const indicator = statusElement.querySelector('.status-indicator');
      const text = statusElement.querySelector('.status-item div span:last-child');
      
      if (indicator) indicator.className = `status-indicator ${status}`;
      if (text) text.textContent = message;
    }
  }

  updateStandaloneStatus() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    this.isStandalone = isStandalone;
    
    if (this.elements.standaloneStatus) {
      this.elements.standaloneStatus.textContent = isStandalone ? 'Yes ‚úÖ' : 'No ‚ùå';
    }
    
    this.updateStatus(3, isStandalone ? 'good' : 'bad', 
      isStandalone ? 'Running as App' : 'Not in App Mode');
    
    return isStandalone;
  }

  // GitHub Pages compatible Service Worker registration
  async registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
      this.log('Service Worker not supported by browser', 'error');
      this.updateStatus(0, 'bad', 'Not Supported');
      return false;
    }

    try {
      // Try multiple registration strategies for GitHub Pages
      const strategies = [
        { path: 'sw.js', scope: './' },
        { path: './sw.js', scope: './' },
        { path: 'sw.js', scope: '.' },
        { path: './sw.js', scope: '.' }
      ];

      let registration = null;
      
      for (let strategy of strategies) {
        try {
          this.log(`Trying SW: ${strategy.path} with scope: ${strategy.scope}`, 'info');
          registration = await navigator.serviceWorker.register(strategy.path, {
            scope: strategy.scope,
            updateViaCache: 'none'
          });
          
          this.log(`‚úÖ Service Worker registered successfully with scope: ${registration.scope}`, 'success');
          this.updateStatus(0, 'good', 'Registered');
          return true;
          
        } catch (err) {
          this.log(`Failed: ${strategy.path} - ${err.message}`, 'warning');
          continue;
        }
      }

      // If all strategies fail
      throw new Error('All Service Worker registration strategies failed');

    } catch (error) {
      this.log(`‚ùå Service Worker failed: ${error.message}`, 'error');
      this.updateStatus(0, 'bad', 'Registration Failed');
      
      // Even if SW fails, we can still be a PWA with manifest
      this.log('‚ö†Ô∏è Continuing without Service Worker - limited functionality', 'warning');
      return false;
    }
  }

  checkManifest() {
    return new Promise((resolve) => {
      const manifestLink = document.querySelector('link[rel="manifest"]');
      if (!manifestLink) {
        this.log('No manifest link found', 'error');
        this.updateStatus(1, 'bad', 'Not Found');
        resolve(false);
        return;
      }

      fetch(manifestLink.href)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(manifest => {
          this.log('‚úÖ Manifest loaded successfully', 'success');
          this.updateStatus(1, 'good', 'Loaded');
          
          // Check critical manifest properties
          const hasIcons = manifest.icons && manifest.icons.length > 0;
          const hasStartUrl = manifest.start_url;
          
          if (!hasIcons) this.log('‚ö†Ô∏è Manifest missing icons', 'warning');
          if (!hasStartUrl) this.log('‚ö†Ô∏è Manifest missing start_url', 'warning');
          
          resolve(true);
        })
        .catch(error => {
          this.log(`‚ùå Manifest error: ${error.message}`, 'error');
          this.updateStatus(1, 'bad', 'Load Failed');
          resolve(false);
        });
    });
  }

  setupPWAEvents() {
    // Listen for beforeinstallprompt (Android/Chrome)
    window.addEventListener('beforeinstallprompt', (e) => {
      this.log('üéâ PWA installation available!', 'success');
      e.preventDefault();
      this.deferredPrompt = e;
      
      // Enable install button
      if (this.elements.installBtn) {
        this.elements.installBtn.disabled = false;
        this.elements.installBtn.textContent = 'üì≤ Install Now';
        this.elements.installBtn.style.background = 'linear-gradient(135deg, #FF6B6B, #FF8E53)';
      }
      
      this.updateStatus(2, 'good', 'Ready to Install!');
      
      // Show platform-specific instructions
      if (this.isAndroid && this.elements.androidInstructions) {
        this.elements.androidInstructions.classList.add('active');
      }
    });

    // Install button handler
    if (this.elements.installBtn) {
      this.elements.installBtn.addEventListener('click', () => {
        this.installPWA();
      });
    }

    // Track successful installation
    window.addEventListener('appinstalled', (e) => {
      this.log('üéä PWA successfully installed!', 'success');
      this.updateStatus(2, 'good', 'Installed! üéâ');
      this.updateStandaloneStatus();
      
      if (this.elements.installBtn) {
        this.elements.installBtn.disabled = true;
        this.elements.installBtn.textContent = '‚úÖ Installed';
      }
    });

    // Show iOS instructions
    if (this.isIOS && this.elements.iosInstructions) {
      this.elements.iosInstructions.classList.add('active');
    }
  }

  async installPWA() {
    if (this.deferredPrompt) {
      try {
        this.log('Starting PWA installation...', 'info');
        this.deferredPrompt.prompt();
        
        const choiceResult = await this.deferredPrompt.userChoice;
        this.log(`User choice: ${choiceResult.outcome}`, 'success');
        
        this.deferredPrompt = null;
        
      } catch (error) {
        this.log(`Installation error: ${error.message}`, 'error');
      }
    } else {
      this.log('Installation not available yet', 'warning');
      
      // Show manual instructions
      if (this.isAndroid) {
        alert('For Android: Tap the 3-dot menu ‚Üí "Add to Home screen"');
      } else if (this.isIOS) {
        alert('For iPhone: Tap the share button ‚Üí "Add to Home Screen"');
      } else {
        alert('Check browser menu for "Install app" or "Add to Home screen" option');
      }
    }
  }

  async init() {
    this.log('üöÄ Initializing D\'NestGlobal PWA...', 'rocket');
    this.log(`üìç GitHub Pages: ${this.isGitHubPages}`, 'info');
    this.log(`üì± Platform: ${this.isIOS ? 'iOS' : this.isAndroid ? 'Android' : 'Desktop'}`, 'mobile');
    
    // Update standalone status
    this.updateStandaloneStatus();

    // Register Service Worker (even if it fails, continue)
    await this.registerServiceWorker();

    // Check Manifest
    await this.checkManifest();

    // Setup PWA events
    this.setupPWAEvents();

    // Final status check
    setTimeout(() => {
      this.log('‚úÖ PWA initialization complete', 'success');
      this.log('üí° Tip: On mobile, use browser menu to "Add to Home Screen"', 'info');
      
      // If still not installable after 5 seconds, show manual options
      if (!this.deferredPrompt && !this.isStandalone) {
        this.updateStatus(2, 'warning', 'Use Browser Menu');
        if (this.elements.installBtn) {
          this.elements.installBtn.disabled = false;
          this.elements.installBtn.textContent = 'üì± Manual Install';
        }
      }
    }, 5000);
  }
}

// Initialize PWA when page loads
document.addEventListener('DOMContentLoaded', () => {
  window.pwaManager = new PWAManager();
});

// Update standalone status when display mode changes
window.matchMedia('(display-mode: standalone)').addListener((e) => {
  if (window.pwaManager) {
    window.pwaManager.updateStandaloneStatus();
  }
});
</script>
</body>
</html>
